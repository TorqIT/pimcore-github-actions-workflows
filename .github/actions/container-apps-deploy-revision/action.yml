name: ''
description: ''
inputs:
  TENANT:
    required: true
    description: ""
  SERVICE_PRINCIPAL_ID:
    required: true
    description: ""
  SERVICE_PRINCIPAL_PASSWORD:
    required: true
    description: ""
  RESOURCE_GROUP:
    required: true
    description: ""
  CONTAINER_APP:
    required: true
    description: ""
  CONTAINER_REGISTRY:
    required: true
    description: ""
  IMAGE:
    required: true
    description: ""
  MULTI_REVISION:
    required: false
    description: ""
    default: "false"

runs:
  using: "composite"
  steps:    
    - name: Setup jq for parsing JSON
      uses: dcarbone/install-jq-action@v3
      with:
        version: '1.7'
        force: true

    - name: Build Azure credentials string
      shell: bash
      id: build-creds
      run: |
        azureCreds=$(jq -n \
          --arg clientId "${{ inputs.SERVICE_PRINCIPAL_ID }}" \
          --arg clientSecret "${{ inputs.SERVICE_PRINCIPAL_PASSWORD }}" \
          --arg tenantId "${{ inputs.TENANT }}" \
          '{clientId: $clientId, clientSecret: $clientSecret, tenantId: $tenantId}')
        echo "::add-mask::$azureCreds" 
        echo "azureCreds=$azureCreds" >> $GITHUB_OUTPUT

    - name: Create new revision of Container App
      uses: azure/cli@v2
      with:
        inlineScript: |
          echo Creating new revision of ${{ inputs.CONTAINER_APP }}...
          az containerapp revision copy \
            --resource-group ${{ inputs.RESOURCE_GROUP }} \
            --name ${{ inputs.CONTAINER_APP }} \
            --image ${{ inputs.CONTAINER_REGISTRY }}/${{ inputs.IMAGE }}:${{ github.run_id }} \
            --revision-suffix run-${{ github.run_id }}

    - name: If using a multi-revision setup, ensure that 100% of traffic is set to the latest...
      uses: azure/cli@v2
      if: inputs.MULTI_REVISION == 'true'
      with:
        inlineScript: |
          echo Ensuring latest revision gets 100% of traffic...
          az containerapp ingress traffic set \
            --resource-group ${{ inputs.RESOURCE_GROUP }} \
            --name ${{ inputs.CONTAINER_APP }} \
            --revision-weight latest=100
