# Performs Storage Account and MySQL sync operations from a source Azure Container Apps environment to a target environment.
#
# Invoke this workflow in your project's workflow as follows:
# jobs:
#   sync-with-shutdown:
#     uses: TorqIT/pimcore-github-actions-workflows/.github/workflows/job-azure-sync-with-container-shutdown.yml@v7
#     permissions:
#       contents: read
#       actions: read
#     with:
#       AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
#       SOURCE_SUBSCRIPTION_ID: 12345678-90ab-cdef-1234-567890abcdef
#       TARGET_SUBSCRIPTION_ID: 98765432-10fe-dcba-4321-fedcba098765
#       TARGET_RESOURCE_GROUP: staging-rg
#       TARGET_PHP_CONTAINER_APP: staging-php-app
#       TARGET_SUPERVISORD_CONTAINER_APP: staging-supervisord-app
#       TARGET_STORAGE_ACCOUNT: stagingstorage
#       TARGET_MYSQL_HOST: staging.mysql.example.com
#       TARGET_MYSQL_USERNAME: adminuser
#       TARGET_MYSQL_DATABASE: staging_db
#       SOURCE_RESOURCE_GROUP: production-rg
#       SOURCE_STORAGE_ACCOUNT: prodstorage
#       SOURCE_MYSQL_HOST: prod.mysql.example.com
#       SOURCE_MYSQL_USERNAME: adminuser
#       SOURCE_MYSQL_DATABASE: production_db
#     secrets:
#       SERVICE_PRINCIPAL_ID: ${{ secrets.AZURE_SERVICE_PRINCIPAL_ID }}
#       SERVICE_PRINCIPAL_PASSWORD: ${{ secrets.AZURE_SERVICE_PRINCIPAL_PASSWORD }}
#       SOURCE_MYSQL_PASSWORD: ${{ secrets.PROD_MYSQL_PASSWORD }}
#       TARGET_MYSQL_PASSWORD: ${{ secrets.STAGING_MYSQL_PASSWORD }}
#       SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
#

name: Azure Sync

on:
  workflow_call:
    inputs:
      RUNNER:
        required: false
        type: string
        description: Optional self-hosted runner for this workflow (see https://github.com/TorqIT/pimcore-github-actions-workflows#self-hosted-runners)

      # Azure Configuration
      AZURE_TENANT_ID:
        required: true
        type: string
        description: Azure tenant ID
      SOURCE_SUBSCRIPTION_ID:
        required: true
        type: string
        description: Source subscription ID
      TARGET_SUBSCRIPTION_ID:
        required: true
        type: string
        description: Target subscription ID
      TARGET_RESOURCE_GROUP:
        required: true
        type: string
        description: Target resource group where Container Apps are located
      TARGET_PHP_CONTAINER_APP:
        required: true
        type: string
        description: Name of PHP Container App to shutdown
      TARGET_SUPERVISORD_CONTAINER_APP:
        required: true
        type: string
        description: Name of supervisord Container App to shutdown
      SOURCE_RESOURCE_GROUP:
        required: false
        type: string
        description: Azure Resource Group containing the source Storage Account and MySQL server
      RESTART_APPS_AFTER_SYNC:
        required: false
        type: boolean
        default: true
        description: Whether to restart apps after sync

      # Storage Sync Inputs
      SOURCE_STORAGE_ACCOUNT:
        required: true
        type: string
        description: Name of the source Azure Storage Account
      SOURCE_CONTAINER:
        required: false
        type: string
        default: pimcore-assets
        description: Name of the source Storage Account container
      TARGET_STORAGE_ACCOUNT:
        required: true
        type: string
        description: Name of the target Azure Storage Account
      TARGET_CONTAINER:
        required: false
        type: string
        default: pimcore-assets
        description: Name of the target Storage Account container
      DELETE_DESTINATION:
        required: false
        type: boolean
        default: false
        description: Whether to delete files in destination that don't exist in source (--delete-destination=true)

      # MySQL Sync Inputs
      SOURCE_MYSQL_HOST:
        required: true
        type: string
        description: Hostname or IP address of the source MySQL server
      SOURCE_MYSQL_USERNAME:
        required: true
        type: string
        description: Username for connecting to the source MySQL server
      SOURCE_MYSQL_DATABASE:
        required: true
        type: string
        description: Name of the database/schema to dump from the source server
      SOURCE_MYSQL_PORT:
        required: false
        type: string
        default: "3306"
        description: Port number for the source MySQL server
      SOURCE_MYSQL_SSL_MODE:
        required: false
        type: string
        default: "PREFERRED"
        description: SSL mode for source connection (DISABLED, PREFERRED, REQUIRED, VERIFY_CA, VERIFY_IDENTITY)
      TARGET_MYSQL_HOST:
        required: true
        type: string
        description: Hostname or IP address of the target MySQL server
      TARGET_MYSQL_USERNAME:
        required: true
        type: string
        description: Username for connecting to the target MySQL server
      TARGET_MYSQL_DATABASE:
        required: true
        type: string
        description: Name of the database/schema to restore to on the target server
      TARGET_MYSQL_PORT:
        required: false
        type: string
        default: "3306"
        description: Port number for the target MySQL server
      TARGET_MYSQL_SSL_MODE:
        required: false
        type: string
        default: "PREFERRED"
        description: SSL mode for target connection (DISABLED, PREFERRED, REQUIRED, VERIFY_CA, VERIFY_IDENTITY)
      MYSQLDUMP_OPTIONS:
        required: false
        type: string
        default: "--single-transaction --routines --triggers --add-drop-table --disable-keys --extended-insert --no-tablespaces"
        description: Additional options to pass to mysqldump command
      IGNORE_TABLES:
        required: false
        type: string
        default: "application_logs,versions"
        description: Comma-separated list of tables to ignore during sync (e.g. "table1,table2")
      DROP_TARGET_BEFORE_RESTORE:
        required: false
        type: boolean
        default: false
        description: Whether to drop the target database before restoring

    secrets:
      SERVICE_PRINCIPAL_ID:
        required: true
        description: Azure service principal ID used for authenticating with Azure
      SERVICE_PRINCIPAL_PASSWORD:
        required: true
        description: Azure service principal password used for authenticating with Azure
      SOURCE_MYSQL_PASSWORD:
        required: true
        description: Password for connecting to the source MySQL server
      TARGET_MYSQL_PASSWORD:
        required: true
        description: Password for connecting to the target MySQL server
      SLACK_WEBHOOK_URL:
        required: false
        description: Webhook URL to send job status messages to Slack

jobs:
  shutdown-target-container-apps:
    name: Shutdown target Container Apps
    runs-on: ${{ inputs.RUNNER || 'ubuntu-latest' }}

    steps:
      - name: Get workflow version
        id: workflow-version
        uses: canonical/get-workflow-version-action@v1
        with:
          repository-name: TorqIT/pimcore-github-actions-workflows
          file-name: job-azure-sync.yml
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout workflow repository to use composite actions
        uses: actions/checkout@v4
        with:
          repository: TorqIT/pimcore-github-actions-workflows
          ref: ${{ steps.workflow-version.outputs.sha }}
          path: reusable-workflow
          fetch-depth: 1

      - name: Install tools for workflows/actions
        uses: ./reusable-workflow/.github/actions/setup-tools

      - name: Log in to Azure
        uses: ./reusable-workflow/.github/actions/azure-login
        with:
          SERVICE_PRINCIPAL_ID: ${{ secrets.SERVICE_PRINCIPAL_ID }}
          SERVICE_PRINCIPAL_PASSWORD: ${{ secrets.SERVICE_PRINCIPAL_PASSWORD }}
          TENANT: ${{ inputs.AZURE_TENANT_ID }}
          SUBSCRIPTION: ${{ inputs.TARGET_SUBSCRIPTION_ID }}

      - name: Deactivate PHP Container App revisions
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -e

            echo "Fetching active revisions for PHP Container App: ${{ inputs.TARGET_PHP_CONTAINER_APP }}..."
            activeRevisions=$(az containerapp revision list \
              --resource-group ${{ inputs.TARGET_RESOURCE_GROUP }} \
              --name ${{ inputs.TARGET_PHP_CONTAINER_APP }} \
              --query "[?properties.active==\`true\`].name" \
              --output tsv)

            if [ -z "$activeRevisions" ]; then
              echo "No active revisions found for PHP Container App"
            else
              echo "Deactivating active revisions..."
              for revision in $activeRevisions
              do
                echo "Deactivating revision: $revision"
                az containerapp revision deactivate \
                  --resource-group ${{ inputs.TARGET_RESOURCE_GROUP }} \
                  --name ${{ inputs.TARGET_PHP_CONTAINER_APP }} \
                  --revision $revision
              done
              echo "Successfully deactivated all PHP Container App revisions"
            fi

      - name: Deactivate supervisord Container App revisions
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -e

            echo "Fetching active revisions for supervisord Container App: ${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }}..."
            activeRevisions=$(az containerapp revision list \
              --resource-group ${{ inputs.TARGET_RESOURCE_GROUP }} \
              --name ${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }} \
              --query "[?properties.active==\`true\`].name" \
              --output tsv)

            if [ -z "$activeRevisions" ]; then
              echo "No active revisions found for supervisord Container App"
            else
              echo "Deactivating active revisions..."
              for revision in $activeRevisions
              do
                echo "Deactivating revision: $revision"
                az containerapp revision deactivate \
                  --resource-group ${{ inputs.TARGET_RESOURCE_GROUP }} \
                  --name ${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }} \
                  --revision $revision
              done
              echo "Successfully deactivated all supervisord Container App revisions"
            fi

      - name: Check Slack webhook URL
        id: check-webhook-url
        # Hacky workaround to get around the fact that we cannot reference secrets in a conditional
        run: |
          if [ "${{ secrets.SLACK_WEBHOOK_URL }}" != '' ]; then
            echo "Slack webhook URL is defined"
            echo "slackWebhookDefined=true" >> $GITHUB_OUTPUT;
          else
            echo "Slack webhook URL is not defined"
            echo "slackWebhookDefined=false" >> $GITHUB_OUTPUT;
          fi

      - name: Send shutdown status to Slack
        if: ${{ steps.check-webhook-url.outputs.slackWebhookDefined == 'true' }}
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "*Container Apps Shutdown Complete*"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Container Apps shutdown for ${{ github.repository }}*: Success! :white_check_mark:\n\n*PHP Container App:* `${{ inputs.TARGET_PHP_CONTAINER_APP }}`\n*Supervisord Container App:* `${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }}`\n*Resource Group:* `${{ inputs.TARGET_RESOURCE_GROUP }}`\n\nProceeding with storage and database sync...\n\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  storage-sync:
    name: Storage sync
    needs: shutdown-target-container-apps
    permissions:
      contents: read
      actions: read
    uses: ./.github/workflows/job-azure-storage-sync.yml
    with:
      RUNNER: ${{ inputs.RUNNER }}
      SOURCE_STORAGE_ACCOUNT: ${{ inputs.SOURCE_STORAGE_ACCOUNT }}
      SOURCE_CONTAINER: ${{ inputs.SOURCE_CONTAINER }}
      SOURCE_RESOURCE_GROUP: ${{ inputs.SOURCE_RESOURCE_GROUP }}
      TARGET_STORAGE_ACCOUNT: ${{ inputs.TARGET_STORAGE_ACCOUNT }}
      TARGET_CONTAINER: ${{ inputs.TARGET_CONTAINER }}
      TARGET_RESOURCE_GROUP: ${{ inputs.TARGET_RESOURCE_GROUP }}
      DELETE_DESTINATION: ${{ inputs.DELETE_DESTINATION }}
      AZURE_TENANT_ID: ${{ inputs.AZURE_TENANT_ID }}
      SOURCE_SUBSCRIPTION_ID: ${{ inputs.SOURCE_SUBSCRIPTION_ID }}
      TARGET_SUBSCRIPTION_ID: ${{ inputs.TARGET_SUBSCRIPTION_ID }}
    secrets:
      AZURE_SERVICE_PRINCIPAL_ID: ${{ secrets.SERVICE_PRINCIPAL_ID }}
      AZURE_SERVICE_PRINCIPAL_PASSWORD: ${{ secrets.SERVICE_PRINCIPAL_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  mysql-sync:
    name: MySQL sync
    needs: shutdown-target-container-apps
    permissions:
      contents: read
      actions: read
    uses: ./.github/workflows/job-mysql-sync.yml
    with:
      RUNNER: ${{ inputs.RUNNER }}
      SOURCE_HOST: ${{ inputs.SOURCE_MYSQL_HOST }}
      SOURCE_USERNAME: ${{ inputs.SOURCE_MYSQL_USERNAME }}
      SOURCE_DATABASE: ${{ inputs.SOURCE_MYSQL_DATABASE }}
      SOURCE_PORT: ${{ inputs.SOURCE_MYSQL_PORT }}
      SOURCE_SSL_MODE: ${{ inputs.SOURCE_MYSQL_SSL_MODE }}
      SOURCE_IS_IN_AZURE: true
      SOURCE_AZURE_RESOURCE_GROUP: ${{ inputs.SOURCE_RESOURCE_GROUP }}
      TARGET_HOST: ${{ inputs.TARGET_MYSQL_HOST }}
      TARGET_USERNAME: ${{ inputs.TARGET_MYSQL_USERNAME }}
      TARGET_DATABASE: ${{ inputs.TARGET_MYSQL_DATABASE }}
      TARGET_PORT: ${{ inputs.TARGET_MYSQL_PORT }}
      TARGET_SSL_MODE: ${{ inputs.TARGET_MYSQL_SSL_MODE }}
      TARGET_IS_IN_AZURE: true
      TARGET_AZURE_RESOURCE_GROUP: ${{ inputs.TARGET_RESOURCE_GROUP }}
      MYSQLDUMP_OPTIONS: ${{ inputs.MYSQLDUMP_OPTIONS }}
      AZURE_TENANT_ID: ${{ inputs.AZURE_TENANT_ID }}
      AZURE_SOURCE_SUBSCRIPTION_ID: ${{ inputs.SOURCE_SUBSCRIPTION_ID }}
      AZURE_TARGET_SUBSCRIPTION_ID: ${{ inputs.TARGET_SUBSCRIPTION_ID }}
      DROP_TARGET_BEFORE_RESTORE: ${{ inputs.DROP_TARGET_BEFORE_RESTORE }}
      IGNORE_TABLES: ${{ inputs.IGNORE_TABLES }}
    secrets:
      AZURE_SERVICE_PRINCIPAL_ID: ${{ secrets.SERVICE_PRINCIPAL_ID }}
      AZURE_SERVICE_PRINCIPAL_PASSWORD: ${{ secrets.SERVICE_PRINCIPAL_PASSWORD }}
      SOURCE_PASSWORD: ${{ secrets.SOURCE_MYSQL_PASSWORD }}
      TARGET_PASSWORD: ${{ secrets.TARGET_MYSQL_PASSWORD }}
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  restart-target-container-apps:
    name: Restart target Container Apps
    needs: [storage-sync, mysql-sync]
    if: ${{ inputs.RESTART_APPS_AFTER_SYNC }}
    runs-on: ${{ inputs.RUNNER || 'ubuntu-latest' }}

    steps:
      - name: Get workflow version
        id: workflow-version
        uses: canonical/get-workflow-version-action@v1
        with:
          repository-name: TorqIT/pimcore-github-actions-workflows
          file-name: job-azure-sync.yml
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Checkout workflow repository to use composite actions
        uses: actions/checkout@v4
        with:
          repository: TorqIT/pimcore-github-actions-workflows
          ref: ${{ steps.workflow-version.outputs.sha }}
          path: reusable-workflow
          fetch-depth: 1

      - name: Install tools for workflows/actions
        uses: ./reusable-workflow/.github/actions/setup-tools

      - name: Log in to Azure
        uses: ./reusable-workflow/.github/actions/azure-login
        with:
          SERVICE_PRINCIPAL_ID: ${{ secrets.SERVICE_PRINCIPAL_ID }}
          SERVICE_PRINCIPAL_PASSWORD: ${{ secrets.SERVICE_PRINCIPAL_PASSWORD }}
          TENANT: ${{ inputs.AZURE_TENANT_ID }}
          SUBSCRIPTION: ${{ inputs.TARGET_SUBSCRIPTION_ID }}

      # - name: Restart PHP Container App
      #   uses: azure/cli@v2
      #   with:
      #     inlineScript: |
      #       set -e

      #       echo "Restarting PHP Container App: ${{ inputs.TARGET_PHP_CONTAINER_APP }}..."
      #       az containerapp revision restart \
      #         --resource-group ${{ inputs.TARGET_RESOURCE_GROUP }} \
      #         --name ${{ inputs.TARGET_PHP_CONTAINER_APP }}

      #       echo "PHP Container App restarted successfully"

      # - name: Restart supervisord Container App
      #   uses: azure/cli@v2
      #   with:
      #     inlineScript: |
      #       set -e

      #       echo "Restarting supervisord Container App: ${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }}..."
      #       az containerapp revision restart \
      #         --resource-group ${{ inputs.TARGET_RESOURCE_GROUP }} \
      #         --name ${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }}

      #       echo "Supervisord Container App restarted successfully"

      - name: Check Slack webhook URL
        id: check-webhook-url
        if: always()
        # Hacky workaround to get around the fact that we cannot reference secrets in a conditional
        run: |
          if [ "${{ secrets.SLACK_WEBHOOK_URL }}" != '' ]; then
            echo "Slack webhook URL is defined"
            echo "slackWebhookDefined=true" >> $GITHUB_OUTPUT;
          else
            echo "Slack webhook URL is not defined"
            echo "slackWebhookDefined=false" >> $GITHUB_OUTPUT;
          fi

      - name: Send final status to Slack
        if: ${{ always() && steps.check-webhook-url.outputs.slackWebhookDefined == 'true' }}
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            text: "*Azure Sync with Container Shutdown Complete*"
            blocks:
              - type: "section"
                text:
                  type: "mrkdwn"
                  text: "*Sync and restart job for ${{ github.repository }}*: ${{ job.status == 'success' && 'Success! :white_check_mark:' || 'Failed :x:' }}\n\n*PHP Container App:* `${{ inputs.TARGET_PHP_CONTAINER_APP }}`\n*Supervisord Container App:* `${{ inputs.TARGET_SUPERVISORD_CONTAINER_APP }}`\n*Source Storage:* `${{ inputs.SOURCE_STORAGE_ACCOUNT }}/${{ inputs.SOURCE_CONTAINER }}`\n*Target Storage:* `${{ inputs.TARGET_STORAGE_ACCOUNT }}/${{ inputs.TARGET_CONTAINER }}`\n*Source Database:* `${{ inputs.SOURCE_MYSQL_HOST }}/${{ inputs.SOURCE_MYSQL_DATABASE }}`\n*Target Database:* `${{ inputs.TARGET_MYSQL_HOST }}/${{ inputs.TARGET_MYSQL_DATABASE }}`\n\n${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
